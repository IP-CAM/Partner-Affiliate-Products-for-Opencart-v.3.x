<?xml version="1.0" encoding="utf-8"?>
<modification>
  <name>Partner Products</name>
  <code>partner_products</code>
  <version>1.0.0</version>
  <author>bbldn05</author>
  <link>http://github.com.bbldn</link>
  <!-- Start Admin -->
  <file path="admin/view/template/catalog/product_form.twig">
    <operation>
        <search><![CDATA[<li><a href="#tab-design" data-toggle="tab">{{ tab_design }}</a></li>]]></search>
        <add position="after"><![CDATA[
            <li><a href="#tab-partner" data-toggle="tab">Партнерский товар</a></li>
    ]]></add>
    </operation>
    <operation>
        <search><![CDATA[<div class="tab-pane active" id="tab-general">]]></search>
        <add position="before"><![CDATA[
            <div class="tab-pane" id="tab-partner">
                <div class="form-group">
                    <label class="col-sm-2 control-label" for="input-partner-html">Ссылка/Код</label>
                    <div class="col-sm-10">
        	            <textarea name="partner_html" placeholder="Ссылка" id="input-partner-html" class="form-control">{% if partner %}{{ partner_html }}{% endif %}</textarea>
        	        </div>
                </div>
             </div>
        ]]></add>
    </operation>
  </file>
  <file path="admin/model/catalog/product.php">
    <operation>
        <search><![CDATA[$product_id = $this->db->getLastId();]]></search>
        <add position="after"><![CDATA[
                $html = true === key_exists('partner_html', $data) ? trim($data['partner_html']) : null;
                if (null !== $html && 0 === mb_strlen($html)) {
                    $html = null;
                }
        		$query = $this->db->query("SELECT `product_id` FROM `" . DB_PREFIX . "product_partner` WHERE `product_id` = " . (int)$product_id);
		        
        		if ($query->num_rows > 0) {
        		    if (null === $html) {
        		        $this->db->query("DELETE FROM `" . DB_PREFIX . "product_partner` WHERE `product_id` = " . (int)$product_id);
			        } else {
			    	    $this->db->query("UPDATE `" . DB_PREFIX . "product_partner` SET `html` = '" . html_entity_decode($html) . "' WHERE `product_id` = " . (int)$product_id);
		    	    }
		        } else {
			        if (null !== $html) {
				        $this->db->query("INSERT INTO `" . DB_PREFIX . "product_partner` (`product_id`, `html`) VALUE (" . (int)$product_id . ", '" . html_entity_decode($html) . "')");
			        }
		        }
        ]]></add>
    </operation>
 </file>
  <file path="admin/model/catalog/product.php">
    <operation>
        <search><![CDATA[public function editProduct($product_id, $data) {]]></search>
        <add position="after"><![CDATA[
                $html = true === key_exists('partner_html', $data) ? trim($data['partner_html']) : null;
                if (null !== $html && 0 === mb_strlen($html)) {
                    $html = null;
                }
        		$query = $this->db->query("SELECT product_id FROM " . DB_PREFIX . "product_partner WHERE product_id = " . (int)$product_id);
		        
        		if ($query->num_rows > 0) {
        		    if (null === $html) {
        		        $this->db->query("DELETE FROM `" . DB_PREFIX . "product_partner` WHERE `product_id` = " . (int)$product_id);
			        } else {
			    	    $this->db->query("UPDATE `" . DB_PREFIX . "product_partner` SET `html` = '" . html_entity_decode($html) . "' WHERE `product_id` = " . (int)$product_id);
		    	    }
		        } else {
			        if (null !== $html) {
				        $this->db->query("INSERT INTO `" . DB_PREFIX . "product_partner` (`product_id`, `html`) VALUE (" . (int)$product_id . ", '" . html_entity_decode($html) . "')");
			        }
		        }
        ]]></add>
    </operation>
 </file>
 <file path="admin/model/catalog/product.php">
    <operation>
        <search><![CDATA[class ModelCatalogProduct extends Model {]]></search>
        <add position="after"><![CDATA[
    /**
	 * getPartnerByProductId
	 *
	 * @param  mixed $product_id
	 * @return array
	 */
	public function getPartnerByProductId($product_id) 
	{
		$query = $this->db->query("SELECT COUNT(pp.`product_id`) > 0 as `exists`, pp.`html` FROM `" . DB_PREFIX . "product_partner` pp WHERE pp.`product_id` = " . $product_id);
		
		return $query->row;
	}
	
	]]></add>
    </operation>
  </file>
  <file path="admin/controller/catalog/product.php">
    <operation>
        <search><![CDATA[if (isset($this->request->post['points'])) {]]></search>
        <add position="before"><![CDATA[
        $partner = $this->model_catalog_product->getPartnerByProductId((int)$this->request->get['product_id']);
		$data['partner'] = true === key_exists('exists', $partner) ? $partner['exists'] : false;
		$data['partner_html'] = true === key_exists('html', $partner) ? $partner['html'] : '';
        ]]></add>
    </operation>
  </file>
 <!-- End Admin -->
 <!-- Start Catalog -->
 <file path="catalog/model/catalog/product.php">
    <operation>
      <search><![CDATA[public function updateViewed($product_id) {]]></search>
      <add position="before"><![CDATA[
    /**
	 * getPartnerByProductId
	 *
	 * @param  mixed $product_id
	 * @return array
	 */
	public function getPartnerByProductId($product_id) 
	{
		$query = $this->db->query("SELECT COUNT(pp.`product_id`) > 0 as `exists`, pp.`html` FROM `" . DB_PREFIX . "product_partner` pp WHERE pp.`product_id` = " . $product_id);
		
		return $query->row;
	}
	
	/**
	 * getPartnerByProductIds
	 *
	 * @param  int[] $product_ids
	 * @return array
	 */
	public function getPartnerByProductIds($product_ids) 
	{
	    $result = [];
	    if (0 === count($product_ids)) {
	        return $result;
	    }

	    foreach($product_ids as $id) {
	        $result[$id] = false;
	    }

		$query = $this->db->query("SELECT pp.`product_id` FROM `" . DB_PREFIX . "product_partner` pp WHERE pp.`product_id` IN (" . implode(',', $product_ids) . ")");

		foreach ($query->rows as $row) {
		    $result[(int)$row['product_id']] = true;
		}

		return $result;
	}
	
	]]></add>
    </operation>
  </file>
  <file path="catalog/controller/product/product.php">
    <operation>
      <search><![CDATA[public function index() {]]></search>
      <add position="before"><![CDATA[
			public function partnerIndex() {
			    $this->load->model('catalog/product');
			    $partner = $this->model_catalog_product->getPartnerByProductId((int)$this->request->get['partner_id']);
			    $html = '';
			    if (true === key_exists('html', $partner)) {
			        $html = trim(html_entity_decode($partner['html']));
			    }
			    if (0 === mb_strlen($html)) {
			        $html = 'false';
			    }
			    $this->response->setOutput($html);
			}
      ]]></add>
    </operation>
  </file>
 
 <!-- End Catalog -->
 <!-- Start Modal Theme -->
 <file path="catalog/view/theme/*/template/common/footer.twig">
    <operation>
      <search><![CDATA[</body></html>]]></search>
      <add position="replace"><![CDATA[
        <!-- Start Partner Product Modal -->
        
        <div id="partner-modal" class="modal fade" role="dialog">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <p class="h4">Купить</p>
              </div>
              <div class="modal-body" id="partner-modal-content"></div>
              <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Закрыть</button>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Start Partner Product Script -->
        <script>
            $(document).ready(function() {
                const partnerHandler = function(data) {
                    if (true === data.startsWith('https://') || true === data.startsWith('http://')) {
                        window.open(data, '_blank').focus();
                        
                        return;
                    }
                    
                    $('#partner-modal-content').html(data);
                    $('#partner-modal').modal('show');
                };

                const backup = cart.add;
                cart.add = function(product_id, quantity) {
                    $.get(`/index.php?route=product/product/partnerIndex&partner_id=${product_id}`, (data) => {
                        if ('false' !== data) {
                            partnerHandler(data);
                            
                            return;
                        }
                        
                        backup(product_id, quantity);
                    });
                }
            });
        </script>
        <!-- End Partner Product Script -->
        <!-- End Partner Product Modal -->
         
        </body></html>
      ]]></add>
    </operation>
 </file>
 <!-- End Modal Theme -->
</modification>
